---
title: "<center>Map making using `mapsf` package in `R`</center>"
author: "<center>Wyclife Agumba Oluoch</center>"
date: "<center>`r Sys.time()`</center>"
output: 
  html_notebook:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Background to the project

With the steady growth in spatial analysis in `R`, there have been gradual attempts to optimize map visualization comparable or better than traditional GUI based GIS such as [QGIS](https://qgis.org/en/site/).In this process, several packages have been developed including tmap, Mapdeck, sf among others. The list has not left out ggplot2 which is the bread-and-butter of visualization in R. When `sf` package was built for wrangling spatial data in a manner similar to regular data.frames in R, the spatial community appreciated the analysis capabilities but were not fully satisfied with visualization of the outputs. This is the niche that has been filled by the development of `mapsf` package. In this tutorial, we are going to see how to use `mapsf` to visualize several vector map types and raster data type. 

## About `mapsf` and installation

`mapsf` is a package which is enabling creating maps of simple features in R. For more information on the package, [see](https://github.com/riatelab/mapsf).

You can install and load the package with the following code:

```{r loading}
# install.packages('mapsf')
library(mapsf)
```

Since it is mapping simple features, loading the library will show _Loading required package: sf_ and of course link to GEOS, GDAL, and PROJ.

## Loading data to map with `mapsf`

The package is coming with an inbuilt data-set for Martinique island in France. We can access the data-set and save it to an object called mtq using the following simple code:

```{r loading_data}
mtq <- mf_get_mtq() # Most of the functions in mapsf package start with mf_
```

## Initializing map development

We can then go ahead and initialize the mapping process. You can think of this as designing the layout pane on which to display the map in [QGIS](https://qgis.org/en/site/), for example. In this case, we use `mf_init()` function as follows:

```{r layout}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk') # This is the layout to map on
```
## Previewing the data to map

Before doing the mapping itself, it is important to preview the dataset so that one understands the available attributes (fields) from which mapping elements can be drawn. We can achieve that by using the `head()` function just like in the case of normal data.frames in `R`.

```{r mtq_object}
head(mtq) # multipolygon, WGS84 projection zone 20Nm 6 features and 7 fields plus bounding box. geom holds the coordinates and not regarded as a field in the 7.
```

# Creating map shadow 

There is a beautiful shadow feature in `mapsf` which can be plotted just before placing the actual map. Actually, it is the shadow of the actual map. We can go ahead and plot the shadow using `mf_shadow()` as follows:

```{r shadow}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_shadow(mtq, col = 'purple', cex = 2, add = TRUE) # Now we have shadow on the layout added
```

### Adding map on the shadow

The next step now is to plot the map itself on top of its shadow. Sounds like an overlay on top of the same layer. However, the shadow will be slightly offset diagonally to depict shadowy plot. 

```{r the_map}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_shadow(mtq, col = 'magenta', cex = 2, add = TRUE) 
mf_map(mtq, type = 'base', add = TRUE) # Awesome
```
# The map layout development
In as much as the map layout looks fine, it is still way below what `mapsf` can do. Let us use the `mf_layout()` function to create a layout more suitable for map creation. The layout will capture north arrow, scale, Source, author, package and version used, and title of the map.

```{r layout_complete}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_layout(title = 'Martinique',
          credits = paste0('Sources: IGN, 2018\n',
          'mapsf ',
          packageVersion('mapsf')))
```
# Adding one of the fields/attributes to the map s proportional

Now we want to show a map of the population since POP is a field in the mtq data per region. We want to represent this as graduated symbol so that we have larger symbols for those regions with higher population values.

```{r pop_map}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_shadow(mtq, col = 'magenta', cex = 2, add = TRUE)
mf_layout(title = 'Martinique',
          credits = paste0('Sources: IGN, 2018\n',
          'mapsf ',
          packageVersion('mapsf')))
mf_map(mtq, add = TRUE)
mf_map(x = mtq, var = 'POP', type = 'prop', inches = 0.25, 
       col = 'purple', leg_pos = 'bottomleft2', leg_title = 'Total population'
)
```

# Adding choropleth map using one attribute

Awesome so far. Here we make a step to the choropleth maps. Since regions are polygons, we can calculate area of each polygon using the st_area() function. Then we can use the population column and the created area values to create a new column called population density. This is given by dividing the population by area.

```{r choropleth}
mtq$POPDENS <- 1e6 * mtq$POP / st_area(mtq)
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_shadow(mtq, col = 'magenta', cex = 2, add = TRUE)
mf_layout(title = 'Martinique',
          credits = paste0('Sources: IGN, 2018\n',
          'mapsf ',
          packageVersion('mapsf')))
mf_map(x = mtq, var = "POPDENS", type = "choro", breaks = "geom", nbreaks = 5,
  col = "Mint", border = "white", lwd = 0.5, leg_pos = "topright", 
  leg_title = "Population Density\n(people per km2)", add = TRUE
)
```
# Mapping categorical variable on the map

We can also plot a map which is showing the character variable in the fields such as the STATUS field. Then we color the map based on individual categories, so all regions having same category will have the same color.

```{r typology}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_shadow(mtq, col = 'gray', cex = 2, add = TRUE)
mf_layout(title = 'Martinique',
          credits = paste0('Sources: IGN, 2018\n',
          'mapsf ',
          packageVersion('mapsf')))
mf_map(x = mtq, var = "STATUS", type = "typo", pal = c("purple", "magenta", "cyan"), lwd = .5, val_order = c("Prefecture", "Sub-prefecture", 
"Simple municipality"), leg_pos = "topright", leg_title = "", add = TRUE)
```
# Labeling some regions of the map

I may need to label some of the regions. This is achievable by using the mf_label() function as follows:

```{r labeling}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_shadow(mtq, col = 'gray', cex = 2, add = TRUE)
mf_layout(title = 'Martinique',
          credits = paste0('Sources: IGN, 2018\n',
          'mapsf ',
          packageVersion('mapsf')))
mf_map(x = mtq, var = "STATUS", type = "typo", pal = c("purple", "magenta", "cyan"), lwd = .5, val_order = c("Prefecture", "Sub-prefecture", 
"Simple municipality"), leg_pos = "topright", leg_title = "", add = TRUE)
mf_label(x = mtq[mtq$STATUS != "Simple municipality", ], var = "LIBGEO", 
         cex = 0.9, halo = TRUE, r = 0.15)
```
# Combining choropleth with proportional map

Both the proportional map can be combined with choropleth coloration. The size of circles and the color density represent different variables. This is achievable with the following code:

```{r propo_choropleth}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_shadow(mtq, col = 'gray', cex = 2, add = TRUE)
mf_layout(title = 'Martinique',
          credits = paste0('Sources: IGN, 2018\n',
          'mapsf ',
          packageVersion('mapsf')))
mf_map(mtq, add = TRUE)
mf_map(x = mtq, var = c("POP", "MED"), type = "prop_choro", border = "grey50",
  lwd = 1, leg_pos = c("topright", "right"), leg_title = c("Population","Median\nIncome\n(in euros)"), breaks = "equal", nbreaks = 4, 
  pal = "Greens", leg_val_rnd = c(0, -2), leg_frame = c(TRUE, TRUE)
)
```
# Making proportional map and typology in one

Proportional map and typology can be mapped on the same map layout using the following code:

```{r propo_typo}
mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
mf_shadow(mtq, col = 'gray', cex = 2, add = TRUE)
mf_layout(title = 'Martinique',
          credits = paste0('Sources: IGN, 2018\n',
          'mapsf ',
          packageVersion('mapsf')))
mf_map(mtq, add = TRUE)
mf_map(x = mtq, var = c("POP","STATUS"), type = "prop_typo", symbol = "square",
  border = "white", lwd = .5, leg_pos = c("right",  "topright"), 
  leg_title = c("Population", "Administrative\nStatus"),
  val_order = c("Prefecture", "Sub-prefecture", "Simple municipality"))
```

Other functions such as `mf_arrow`, `mf_scale`,and `mf_credits` can be used to alter the position of the map aesthetics.

### Adding graticule on the map

It may sometimes, not always, be necessary to add graticule on the map. That can be achieved with the following:

```{r graticule}
#mf_init(mtq, expandBB = rep(0, 4), theme = 'jsk')
#mf_theme(mar = c(2, 2, 1.2, 0)+5)
plot(st_geometry(mtq), border = NA, col = NA, graticule = st_crs(4326),
     axes = TRUE, bg = mf_theme(mar = c(2, 2, 1.2, 0)+2)$bg,
     lon = seq(-62, -60, by = 0.2), lat = seq(14, 15, by = 0.2))
mf_layout(title = 'Martinique',
          credits = paste0('Sources: IGN, 2018\n',
          'mapsf ',
          packageVersion('mapsf')))
mf_shadow(mtq, col = 'gray', cex = 1, add = TRUE)
mf_map(mtq, add = TRUE)

```